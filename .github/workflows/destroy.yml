name: Terraform Destroy

on:
  # Manual trigger only - requires explicit confirmation
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY-CONFIRMED" to proceed with infrastructure destruction'
        required: true
        type: string
      reason:
        description: 'Reason for destroying infrastructure (required for audit trail)'
        required: true
        type: string

env:
  TF_VERSION: '1.7.0'
  AWS_REGION: 'ap-southeast-2'

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest

    # Use production environment for additional protection
    environment:
      name: production-destroy
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    permissions:
      contents: read
      issues: write  # To post destruction notification

    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Validate Confirmation Input
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY-CONFIRMED" ]; then
            echo "‚ùå Confirmation input does not match. Expected: DESTROY-CONFIRMED"
            echo "Received: ${{ github.event.inputs.confirmation }}"
            exit 1
          fi
          echo "‚úÖ Confirmation validated. Proceeding with destroy operation."

      - name: Log Destruction Request
        run: |
          echo "==================================="
          echo "INFRASTRUCTURE DESTRUCTION REQUEST"
          echo "==================================="
          echo "Requested by: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "==================================="

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Terraform Plan Destroy
        id: plan-destroy
        run: |
          # Show what will be destroyed before proceeding
          terraform plan -destroy -no-color -out=destroy-plan 2>&1 | tee destroy_plan_output.txt
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "üî• Starting infrastructure destruction..."
          terraform destroy -auto-approve -no-color 2>&1 | tee destroy_output.txt
          echo "‚úÖ Infrastructure destruction complete."
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Upload Destroy Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: destroy-logs-${{ github.run_id }}
          path: |
            terraform/destroy_plan_output.txt
            terraform/destroy_output.txt
          retention-days: 90  # Keep destroy logs for 90 days for audit

      - name: Create Destruction Notification Issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const destroyStatus = '${{ steps.destroy.outcome }}';
            const reason = `${{ github.event.inputs.reason }}`;
            const actor = '${{ github.actor }}';

            const issueBody = `## Infrastructure Destruction \
            ${destroyStatus === 'success' ? 'Completed' : 'Failed'} \
            ${destroyStatus === 'success' ? '‚úÖ' : '‚ùå'}

            ### Destruction Details
            - **Status:** ${destroyStatus === 'success'
              ? 'Successfully destroyed'
              : 'Failed to destroy'}
            - **Requested By:** @${actor}
            - **Reason:** ${reason}
            - **Timestamp:** ${new Date().toISOString()}
            - **Workflow Run:** [View Details]\
            (${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### What Was Destroyed
            ${destroyStatus === 'success' ? `
            All infrastructure resources managed by Terraform have been destroyed, including:
            - EC2 instances
            - Security groups
            - Associated IAM roles and policies (if any)
            - Network configurations
            ` : 'Destruction failed. Review workflow logs for details.'}

            ### Next Steps
            ${destroyStatus === 'success' ? `
            - ‚úÖ All resources have been removed from AWS
            - ‚úÖ You can safely re-deploy by merging to main branch
            - ‚ö†Ô∏è Terraform state still exists (local or remote backend)
            - ‚ö†Ô∏è Consider backing up or clearing state if starting fresh
            ` : `
            - ‚ùå Review the workflow logs to identify the failure
            - ‚ö†Ô∏è Some resources may be partially destroyed
            - ‚ö†Ô∏è Manual cleanup may be required via AWS Console
            - üîÑ Re-run the destroy workflow after resolving issues
            `}

            ### Audit Trail
            This destruction was performed via the automated destroy workflow with manual approval.
            Logs are retained for 90 days in workflow artifacts.

            ---
            *To prevent accidental destruction, this workflow requires:*
            1. *Manual trigger (workflow_dispatch)*
            2. *Typed confirmation: "DESTROY-CONFIRMED"*
            3. *Required reason field for audit*
            4. *Production environment approval (if configured)*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Infrastructure Destroyed by @${actor} - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['infrastructure', 'destroy', 'audit'],
            });

      - name: Destroy Status Check
        if: steps.destroy.outcome == 'failure'
        run: |
          echo "‚ùå Infrastructure destruction failed. Review logs and manually clean up any orphaned resources."
          exit 1

      - name: Success Summary
        if: steps.destroy.outcome == 'success'
        run: |
          echo "=========================================="
          echo "‚úÖ INFRASTRUCTURE DESTRUCTION SUCCESSFUL"
          echo "=========================================="
          echo "All Terraform-managed resources have been destroyed."
          echo "Requested by: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "=========================================="
